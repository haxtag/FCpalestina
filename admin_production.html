<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Maillots Du Peuple</title>
    <link rel="icon" type="image/png" href="assets/img/fcp3.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // Déterminer l'URL de base de l'API selon l'environnement
        const apiBase = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:8001'
            : '';
        
        // Configuration minimale pour récupérer la base d'images publique (CDN)
        window.CONFIG = window.CONFIG || { 
            IMAGES_BASE_URL: '/assets/images/jerseys',
            API_BASE: apiBase
        };
        
        (async () => {
            try {
                const res = await fetch(`${apiBase}/api/config-public`, { credentials: 'include' });
                if (res.ok) {
                    const pub = await res.json();
                    if (pub && pub.images_base_url) {
                        window.CONFIG.IMAGES_BASE_URL = pub.images_base_url;
                    }
                }
            } catch (_) { /* no-op */ }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c5530;
            --primary-dark: #1e3a21;
            --secondary: #8B1538;
            --accent: #ff1744;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --dark: #333;
            --light: #f8f9fa;
            --border: #dee2e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
        }

        /* Header Admin */
        .admin-header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-logo img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .admin-logo h1 {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-user-info {
            text-align: right;
        }

        .admin-user-name {
            font-weight: 600;
            color: var(--dark);
        }

        .admin-user-role {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .btn-logout {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Navigation Tabs */
        .admin-tabs {
            background: white;
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: var(--light);
            color: var(--primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-bottom-color: var(--secondary);
        }

        /* Container */
        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Actions Section */
        .actions-section {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .actions-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 1rem;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .action-btn.success {
            background: var(--success);
        }

        .action-btn.success:hover {
            background: #218838;
        }

        .action-btn.warning {
            background: var(--warning);
            color: var(--dark);
        }

        .action-btn.warning:hover {
            background: #e0a800;
        }

        /* Jerseys Grid */
        .jerseys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .jersey-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            /* Limiter les transitions pour éviter le clignotement/reflow */
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .jersey-card:hover {
            /* Éviter tout décalage visuel des cartes au survol/clic */
            transform: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }

        .jersey-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: var(--light);
            display: block; /* évite le décalage lié au baseline inline */
        }

        .jersey-content {
            padding: 1rem;
        }

        .jersey-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .jersey-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .jersey-tag {
            background: var(--light);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .jersey-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .btn-icon {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
        }

        .btn-icon.danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-icon.danger:hover {
            background: var(--danger);
            color: white;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Images Selector */
        .images-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .image-option {
            position: relative;
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-option:hover {
            border-color: var(--primary);
        }

        .image-option.selected {
            border-color: var(--success);
            border-width: 3px;
        }

        .image-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-option-check {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--success);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .image-option.selected .image-option-check {
            display: flex;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Pagination */
        .pagination-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }

        .pagination-btn.active {
            background: var(--primary);
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--dark);
            font-weight: 600;
        }

        /* Category/Tag Cards */
        .item-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .item-color-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header {
                padding: 1rem;
            }

            .admin-tabs {
                padding: 0.5rem;
                overflow-x: auto;
            }

            .admin-container {
                padding: 0 1rem;
            }

            .stats-grid,
            .actions-grid,
            .jerseys-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="admin-logo">
            <img src="assets/img/fcp3.png" alt="Maillots Du Peuple">
            <h1>Maillots Du Peuple Admin</h1>
        </div>
        <div class="admin-user">
            <div class="admin-user-info">
                <div class="admin-user-name">
                    <i class="fas fa-user-circle"></i> <span id="username">admin</span>
                </div>
                <div class="admin-user-role">Administrateur</div>
            </div>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </button>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('dashboard')">
            <i class="fas fa-chart-line"></i> Tableau de bord
        </button>
        <button class="tab-btn" onclick="switchTab('jerseys')">
            <i class="fas fa-tshirt"></i> Maillots <span id="jerseys-count">(0)</span>
        </button>
        <button class="tab-btn" onclick="switchTab('categories')">
            <i class="fas fa-tags"></i> Catégories
        </button>
        <button class="tab-btn" onclick="switchTab('tags')">
            <i class="fas fa-tag"></i> Tags
        </button>
        <button class="tab-btn" onclick="switchTab('reviews')">
            <i class="fas fa-star"></i> Avis Vinted
        </button>
    </nav>

    <!-- Container -->
    <div class="admin-container">
        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tshirt"></i></div>
                    <div class="stat-value" id="stat-jerseys-total">0</div>
                    <div class="stat-label">Maillots Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-eye"></i></div>
                    <div class="stat-value" id="stat-jerseys-active">0</div>
                    <div class="stat-label">Maillots Actifs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-star"></i></div>
                    <div class="stat-value" id="stat-reviews">0</div>
                    <div class="stat-label">Avis Clients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-value" id="stat-rating">5.0</div>
                    <div class="stat-label">Note Moyenne</div>
                </div>
            </div>

            <div class="actions-section">
                <div class="actions-title">
                    <i class="fas fa-bolt"></i> Actions Rapides
                </div>
                <div class="actions-grid">
                    <button class="action-btn" onclick="updateVintedReviews()">
                        <i class="fas fa-sync-alt"></i> Mettre à jour les avis Vinted
                    </button>
                    <button class="action-btn warning" id="importYupooBtn" onclick="importYupooJerseys()">
                        <i class="fas fa-download"></i> Importer nouveaux maillots Yupoo
                    </button>
                    <button class="action-btn info" onclick="downloadMissingImages()" id="downloadImagesBtn">
                        <i class="fas fa-images"></i> Télécharger images manquantes (Démo)
                    </button>
                    <button class="action-btn danger" id="cleanJerseysBtn" onclick="cleanJerseysAdmin()">
                        <i class="fas fa-broom"></i> Nettoyer les maillots
                    </button>
                    <button class="action-btn success" onclick="saveAllData()">
                        <i class="fas fa-save"></i> Sauvegarder les données
                    </button>
                </div>
            </div>

            <div class="actions-section">
                <div class="actions-title">
                    <i class="fas fa-info-circle"></i> État du système
                </div>
                <div style="padding: 1rem;">
                    <p><i class="fas fa-check-circle" style="color: var(--success);"></i> Serveur en ligne</p>
                    <p><i class="fas fa-database" style="color: var(--success);"></i> Base de données connectée</p>
                    <p><i class="fas fa-shield-alt" style="color: var(--success);"></i> Sécurité activée</p>
                    <p><i class="fas fa-clock" style="color: var(--warning);"></i> Mise à jour automatique: 2h du matin</p>
                </div>
            </div>
        </div>

        <!-- Jerseys Tab -->
        <div class="tab-content" id="jerseys-tab">
            <div class="loading" id="jerseys-loading">
                <div class="loading-spinner"></div>
                <p>Chargement des maillots...</p>
            </div>
            <div id="jerseys-container" style="display: none;">
                <!-- Pagination Controls -->
                <div class="pagination-controls" style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span style="color: var(--dark); font-weight: 600;">
                            <i class="fas fa-tshirt"></i> <span id="jerseys-showing">0-0</span> sur <span id="jerseys-total-display">0</span>
                        </span>
                        <select id="jerseys-per-page" class="form-select" style="width: auto;" onchange="changePerPage()">
                            <option value="12">12 par page</option>
                            <option value="24" selected>24 par page</option>
                            <option value="48">48 par page</option>
                            <option value="100">100 par page</option>
                        </select>
                    </div>
                    <div class="pagination-buttons" id="pagination-buttons"></div>
                </div>
                
                <div class="jerseys-grid" id="jerseys-grid"></div>
                
                <!-- Pagination Bottom -->
                <div class="pagination-controls" style="margin-top: 2rem;">
                    <div class="pagination-buttons" id="pagination-buttons-bottom"></div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-content" id="categories-tab">
            <div class="actions-section">
                <button class="action-btn success" onclick="openCreateCategoryModal()">
                    <i class="fas fa-plus"></i> Créer une catégorie
                </button>
            </div>
            <div id="categories-list"></div>
        </div>

        <!-- Tags Tab -->
        <div class="tab-content" id="tags-tab">
            <div class="actions-section">
                <button class="action-btn success" onclick="openCreateTagModal()">
                    <i class="fas fa-plus"></i> Créer un tag
                </button>
            </div>
            <div id="tags-list"></div>
        </div>

        <!-- Reviews Tab -->
        <div class="tab-content" id="reviews-tab">
            <div class="actions-section">
                <button class="action-btn" onclick="updateVintedReviews()">
                    <i class="fas fa-sync-alt"></i> Mettre à jour les avis
                </button>
            </div>
            <div id="reviews-list"></div>
        </div>
    </div>

    <!-- Modal Edit Jersey -->
    <div class="modal-overlay" id="edit-jersey-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-edit"></i> Modifier le maillot
                </div>
                <button class="modal-close" onclick="closeModal('edit-jersey-modal')">×</button>
            </div>
            <div class="modal-body">
                <div id="modal-alert"></div>
                <form id="edit-jersey-form" onsubmit="saveJersey(event)">
                    <input type="hidden" id="edit-jersey-id">
                    
                    <div class="form-group">
                        <label class="form-label">Nom du maillot</label>
                        <input type="text" class="form-input" id="edit-jersey-name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="edit-jersey-description"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Catégories</label>
                        <select class="form-select" id="edit-jersey-categories" multiple style="height: 120px;"></select>
                        <small style="color: #6c757d;">Maintenez Ctrl pour sélectionner plusieurs catégories</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <select class="form-select" id="edit-jersey-tags" multiple style="height: 120px;"></select>
                        <small style="color: #6c757d;">Maintenez Ctrl pour sélectionner plusieurs tags</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Image de couverture</label>
                        <div class="images-selector" id="cover-images-selector"></div>
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Enregistrer les modifications
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Create/Edit Category -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-tags"></i> <span id="category-modal-title">Créer une catégorie</span>
                </div>
                <button class="modal-close" onclick="closeModal('category-modal')">×</button>
            </div>
            <div class="modal-body">
                <div id="category-modal-alert"></div>
                <form id="category-form" onsubmit="saveCategory(event)">
                    <input type="hidden" id="edit-category-id">
                    
                    <div class="form-group">
                        <label class="form-label">Nom de la catégorie</label>
                        <input type="text" class="form-input" id="edit-category-name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Couleur</label>
                        <input type="color" class="form-input" id="edit-category-color" value="#2c5530">
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Create/Edit Tag -->
    <div class="modal-overlay" id="tag-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-tag"></i> <span id="tag-modal-title">Créer un tag</span>
                </div>
                <button class="modal-close" onclick="closeModal('tag-modal')">×</button>
            </div>
            <div class="modal-body">
                <div id="tag-modal-alert"></div>
                <form id="tag-form" onsubmit="saveTag(event)">
                    <input type="hidden" id="edit-tag-id">
                    
                    <div class="form-group">
                        <label class="form-label">Nom du tag</label>
                        <input type="text" class="form-input" id="edit-tag-name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Couleur</label>
                        <input type="color" class="form-input" id="edit-tag-color" value="#8B1538">
                    </div>

                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration API - Déterminer l'URL de base selon l'environnement
        const apiHostname = window.location.hostname;
        const API_BASE_URL = (apiHostname === 'localhost' || apiHostname === '127.0.0.1')
            ? 'http://localhost:8001/api'
            : '/api';
        
        // Variables globales
        let jerseys = [];
        let categories = [];
        let tags = [];
        let currentEditJersey = null;
        let currentEditCategory = null;
        let currentEditTag = null;
        
        // Pagination
        let currentPage = 1;
        let jerseysPerPage = 24;
        let filteredJerseys = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadDashboardStats();
            loadJerseys();
            loadCategories();
            loadTags();
        });

        // Vérification authentification
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/status`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/login';
                    return;
                }
                
                document.getElementById('username').textContent = data.username || 'Badis';
            } catch (error) {
                console.error('Erreur auth:', error);
                window.location.href = '/login';
            }
        }

        // Déconnexion
        async function logout() {
            try {
                await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Erreur logout:', error);
            }
            window.location.href = '/login';
        }

        // Switch Tab
        function switchTab(tabName) {
            // Désactiver tous les tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer le tab sélectionné
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Charger les données si nécessaire
            if (tabName === 'jerseys' && jerseys.length === 0) {
                loadJerseys();
            } else if (tabName === 'categories' && categories.length === 0) {
                loadCategories();
            } else if (tabName === 'tags' && tags.length === 0) {
                loadTags();
            }
        }

        // Charger Dashboard Stats
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('stat-jerseys-total').textContent = stats.jerseys?.total || 0;
                    document.getElementById('stat-jerseys-active').textContent = stats.jerseys?.active || 0;
                    document.getElementById('stat-reviews').textContent = stats.reviews?.total || 0;
                    document.getElementById('stat-rating').textContent = (stats.reviews?.average_rating || 5.0).toFixed(1);
                }
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        // Charger Maillots
        async function loadJerseys() {
            try {
                const response = await fetch(`${API_BASE_URL}/jerseys`, {
                    credentials: 'include'
                });
                jerseys = await response.json();
                
                document.getElementById('jerseys-count').textContent = `(${jerseys.length})`;
                document.getElementById('jerseys-loading').style.display = 'none';
                document.getElementById('jerseys-container').style.display = 'block';
                
                displayJerseys();
            } catch (error) {
                console.error('Erreur chargement maillots:', error);
                document.getElementById('jerseys-loading').innerHTML = '<p style="color: red;">Erreur de chargement</p>';
            }
        }

        // Afficher les maillots avec Pagination
        function displayJerseys() {
            filteredJerseys = jerseys; // Pas de filtre pour l'instant
            
            const totalPages = Math.ceil(filteredJerseys.length / jerseysPerPage);
            const startIndex = (currentPage - 1) * jerseysPerPage;
            const endIndex = Math.min(startIndex + jerseysPerPage, filteredJerseys.length);
            const jerseysToShow = filteredJerseys.slice(startIndex, endIndex);
            
            // Afficher les maillots
            const grid = document.getElementById('jerseys-grid');
            // Utiliser window.CONFIG.IMAGES_BASE_URL pour le CDN
            const imagesBase = (window.CONFIG && window.CONFIG.IMAGES_BASE_URL) || '/assets/images/jerseys';
            grid.innerHTML = jerseysToShow.map(jersey => `
                <div class="jersey-card">
                    <img src="${imagesBase}/${jersey.thumbnail || jersey.images[0]}" 
                         alt="${jersey.title}" 
                         class="jersey-image"
                         onerror="this.src='/assets/img/placeholder.jpg'">
                    <div class="jersey-content">
                        <div class="jersey-title">${jersey.title || jersey.name}</div>
                        <div class="jersey-meta">
                            <span class="jersey-tag"><i class="fas fa-folder"></i> ${Array.isArray(jersey.category) ? jersey.category.join(', ') : (jersey.category || 'N/A')}</span>
                            <span class="jersey-tag"><i class="fas fa-images"></i> ${jersey.images?.length || 0} photos</span>
                        </div>
                        <div class="jersey-actions">
                            <button class="btn-icon" onclick="editJersey('${jersey.id}')">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="btn-icon danger" onclick="deleteJersey('${jersey.id}', '${(jersey.title || jersey.name).replace(/'/g, "\\'")}')">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Mettre à jour les infos de pagination
            document.getElementById('jerseys-showing').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('jerseys-total-display').textContent = filteredJerseys.length;
            
            // Afficher les boutons de pagination
            displayPaginationButtons(totalPages);
        }

        // Afficher les boutons de pagination
        function displayPaginationButtons(totalPages) {
            const buttonsHtml = [];
            
            // Bouton Précédent
            buttonsHtml.push(`
                <button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
            `);
            
            // Première page
            if (currentPage > 3) {
                buttonsHtml.push(`<button class="pagination-btn" onclick="changePage(1)">1</button>`);
                if (currentPage > 4) {
                    buttonsHtml.push(`<span class="pagination-info">...</span>`);
                }
            }
            
            // Pages autour de la page actuelle
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                buttonsHtml.push(`
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                        ${i}
                    </button>
                `);
            }
            
            // Dernière page
            if (currentPage < totalPages - 2) {
                if (currentPage < totalPages - 3) {
                    buttonsHtml.push(`<span class="pagination-info">...</span>`);
                }
                buttonsHtml.push(`<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`);
            }
            
            // Bouton Suivant
            buttonsHtml.push(`
                <button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            `);
            
            const html = buttonsHtml.join('');
            document.getElementById('pagination-buttons').innerHTML = html;
            document.getElementById('pagination-buttons-bottom').innerHTML = html;
        }

        // Changer de page
        function changePage(page) {
            const totalPages = Math.ceil(filteredJerseys.length / jerseysPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayJerseys();
            // Scroll to top (sans animation pour éviter les saccades)
            const tab = document.getElementById('jerseys-tab');
            if (tab && typeof tab.scrollIntoView === 'function') {
                tab.scrollIntoView();
            }
        }

        // Changer le nombre par page
        function changePerPage() {
            jerseysPerPage = parseInt(document.getElementById('jerseys-per-page').value);
            currentPage = 1;
            displayJerseys();
        }

        // Éditer Maillot
        async function editJersey(jerseyId) {
            const jersey = jerseys.find(j => j.id === jerseyId);
            if (!jersey) return;
            
            currentEditJersey = jersey;
            
            // Remplir le formulaire
            document.getElementById('edit-jersey-id').value = jersey.id;
            document.getElementById('edit-jersey-name').value = jersey.title || jersey.name;
            document.getElementById('edit-jersey-description').value = jersey.description || '';
            
            // Charger catégories
            await loadCategoriesForSelect();
            const categoriesSelect = document.getElementById('edit-jersey-categories');
            const jerseyCategories = Array.isArray(jersey.category) ? jersey.category : (jersey.category ? [jersey.category] : []);
            Array.from(categoriesSelect.options).forEach(option => {
                option.selected = jerseyCategories.includes(option.value);
            });
            
            // Charger tags
            await loadTagsForSelect();
            const tagsSelect = document.getElementById('edit-jersey-tags');
            Array.from(tagsSelect.options).forEach(option => {
                option.selected = jersey.tags?.includes(option.value);
            });
            
            // Afficher images pour sélection cover
            displayCoverImageSelector(jersey);
            
            // Ouvrir modal
            document.getElementById('edit-jersey-modal').classList.add('active');
        }

        // Afficher sélecteur d'image de couverture
        function displayCoverImageSelector(jersey) {
            const container = document.getElementById('cover-images-selector');
                // Utiliser window.CONFIG.IMAGES_BASE_URL pour le CDN
                const imagesBase = (window.CONFIG && window.CONFIG.IMAGES_BASE_URL) || '/assets/images/jerseys';
            container.innerHTML = (jersey.images || []).map(img => `
                <div class="image-option ${jersey.thumbnail === img ? 'selected' : ''}" 
                     onclick="selectCoverImage('${img}')">
                        <img src="${imagesBase}/${img}" alt="">
                    <div class="image-option-check"><i class="fas fa-check"></i></div>
                </div>
            `).join('');
        }

        // Sélectionner image de couverture
        function selectCoverImage(imageName) {
            document.querySelectorAll('.image-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            currentEditJersey.thumbnail = imageName;
        }

        // Sauvegarder Maillot
        async function saveJersey(event) {
            event.preventDefault();
            
            const jerseyId = document.getElementById('edit-jersey-id').value;
            const name = document.getElementById('edit-jersey-name').value;
            const description = document.getElementById('edit-jersey-description').value;
            const categoriesSelect = document.getElementById('edit-jersey-categories');
            const selectedCategories = Array.from(categoriesSelect.selectedOptions).map(opt => opt.value);
            const tagsSelect = document.getElementById('edit-jersey-tags');
            const selectedTags = Array.from(tagsSelect.selectedOptions).map(opt => opt.value);
            
            try {
                const response = await fetch(`${API_BASE_URL}/jerseys/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        jersey_id: jerseyId,
                        name: name,
                        description: description,
                        category: selectedCategories,
                        tags: selectedTags
                    })
                });
                
                if (response.ok) {
                    // Mettre à jour l'image de couverture si modifiée
                    if (currentEditJersey.thumbnail) {
                        await fetch(`${API_BASE_URL}/jerseys/update-cover`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                jersey_id: jerseyId,
                                cover_image: currentEditJersey.thumbnail
                            })
                        });
                    }
                    
                    showAlert('modal-alert', 'Maillot mis à jour avec succès !', 'success');
                    setTimeout(() => {
                        closeModal('edit-jersey-modal');
                        loadJerseys();
                        loadDashboardStats();
                    }, 1500);
                } else {
                    showAlert('modal-alert', 'Erreur lors de la mise à jour', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('modal-alert', 'Erreur serveur', 'error');
            }
        }

        // Supprimer Maillot
        async function deleteJersey(jerseyId, jerseyName) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer "${jerseyName}" ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/jerseys/${jerseyId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('Maillot supprimé avec succès !');
                    loadJerseys();
                    loadDashboardStats();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur serveur');
            }
        }

        // Charger Catégories pour Select
        async function loadCategoriesForSelect() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`, {
                    credentials: 'include'
                });
                categories = await response.json();
                
                const select = document.getElementById('edit-jersey-categories');
                select.innerHTML = categories.map(cat => `
                    <option value="${cat.id}">${cat.name}</option>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement catégories:', error);
            }
        }

        // Charger Tags pour Select
        async function loadTagsForSelect() {
            try {
                const response = await fetch(`${API_BASE_URL}/tags`, {
                    credentials: 'include'
                });
                tags = await response.json();
                
                const select = document.getElementById('edit-jersey-tags');
                select.innerHTML = tags.map(tag => `
                    <option value="${tag.id}">${tag.name}</option>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement tags:', error);
            }
        }

        // Charger Catégories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`, {
                    credentials: 'include'
                });
                categories = await response.json();
                displayCategories();
            } catch (error) {
                console.error('Erreur chargement catégories:', error);
            }
        }

        // Afficher Catégories
        function displayCategories() {
            const list = document.getElementById('categories-list');
            list.innerHTML = `
                <div class="jerseys-grid">
                    ${categories.map(cat => `
                        <div class="item-card">
                            <div class="item-color-preview" style="background: ${cat.color || '#2c5530'};">
                                <i class="fas fa-tags"></i> ${cat.name}
                            </div>
                            <div class="jersey-actions">
                                <button class="btn-icon" onclick="editCategory('${cat.id}')">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="btn-icon danger" onclick="deleteCategory('${cat.id}')">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Charger Tags
        async function loadTags() {
            try {
                const response = await fetch(`${API_BASE_URL}/tags`, {
                    credentials: 'include'
                });
                tags = await response.json();
                displayTags();
            } catch (error) {
                console.error('Erreur chargement tags:', error);
            }
        }

        // Afficher Tags
        function displayTags() {
            const list = document.getElementById('tags-list');
            list.innerHTML = `
                <div class="jerseys-grid">
                    ${tags.map(tag => `
                        <div class="item-card">
                            <div class="item-color-preview" style="background: ${tag.color || '#8B1538'};">
                                <i class="fas fa-tag"></i> ${tag.name}
                            </div>
                            <div class="jersey-actions">
                                <button class="btn-icon" onclick="editTag('${tag.id}')">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="btn-icon danger" onclick="deleteTag('${tag.id}')">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Actions Rapides
        async function updateVintedReviews() {
            if (!confirm('Mettre à jour les avis Vinted ? Cela peut prendre quelques minutes.')) {
                return;
            }
            alert('Fonctionnalité en cours de développement');
        }

        async function importYupooJerseys() {
            // Demander le nombre de maillots à importer
            const limit = prompt('Combien de nouveaux albums traiter ?\n(0 ou vide = tous les albums, 50-100 = rapide)', '50');
            
            if (limit === null) {
                return; // Annulé
            }
            
            const limitNum = parseInt(limit) || 0;
            const message = limitNum > 0 
                ? `Importer les ${limitNum} albums les plus récents ?`
                : 'Importer TOUS les nouveaux maillots ? (peut être long)';
            
            if (!confirm(message)) {
                return;
            }

            const btn = document.getElementById('importYupooBtn');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Import en cours...';
            }

            try {
                const payload = { fresh: false };
                if (limitNum > 0) {
                    payload.limit = limitNum;
                }
                
                const response = await fetch(`${API_BASE_URL}/admin/import-yupoo`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Import Yupoo terminé avec succès!\n\n' + (data.output ? data.output.substring(0, 500) : 'Consultez les logs.'));
                    // Recharger les données
                    loadJerseys();
                    loadStats();
                } else {
                    alert('Erreur lors de l\'import Yupoo:\n' + (data.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur import Yupoo:', error);
                alert('Erreur de connexion au serveur lors de l\'import.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText || '<i class="fas fa-download"></i> Importer nouveaux maillots Yupoo';
                }
            }
        }

        async function cleanJerseysAdmin() {
            const modeChoice = prompt('Nettoyage:\n1 = Supprimer les N derniers\n2 = Supprimer sans images\n3 = Supprimer doublons\n4 = Complet (doublons + sans images)', '1');
            if (modeChoice === null) return;

            let mode = 'last';
            if (modeChoice === '2') mode = 'no-images';
            else if (modeChoice === '3') mode = 'duplicates';
            else if (modeChoice === '4') mode = 'all';

            let number = 0;
            if (mode === 'last') {
                const nStr = prompt('Combien de maillots supprimer (les plus récents) ?', '200');
                if (nStr === null) return;
                number = parseInt(nStr) || 0;
                if (number <= 0) {
                    alert('Nombre invalide');
                    return;
                }
            }

            const confirmMsg = mode === 'last'
                ? `Supprimer les ${number} derniers maillots ?`
                : `Lancer le nettoyage (${mode}) ?`;

            if (!confirm(confirmMsg)) return;

            const btn = document.getElementById('cleanJerseysBtn');
            const original = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Nettoyage...';
            }

            try {
                const payload = { mode };
                if (mode === 'last') payload.number = number;

                const response = await fetch(`${API_BASE_URL}/admin/clean-jerseys`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Nettoyage terminé\n\n' + (data.output ? data.output.substring(0, 600) : '')); 
                    loadJerseys();
                    loadStats();
                } else {
                    alert('Erreur nettoyage:\n' + (data.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur clean jerseys:', error);
                alert('Erreur de connexion au serveur lors du nettoyage.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = original || '<i class="fas fa-broom"></i> Nettoyer les maillots';
                }
            }
        }

        async function downloadMissingImages() {
            if (!confirm('Télécharger les images manquantes ? Cela peut prendre 5-10 minutes.')) {
                return;
            }
            
            const btn = document.getElementById('downloadImagesBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Téléchargement en cours...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/download-images`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Images téléchargées avec succès !\n\n' + (data.output || ''));
                } else {
                    alert('Erreur lors du téléchargement :\n' + (data.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de connexion au serveur');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function saveAllData() {
            alert('Données sauvegardées automatiquement !');
        }

        // Utilitaires
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Vider tous les alerts
            const alerts = ['modal-alert', 'category-modal-alert', 'tag-modal-alert'];
            alerts.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
        }

        // ===== GESTION CATÉGORIES =====
        function openCreateCategoryModal() {
            currentEditCategory = null;
            document.getElementById('category-modal-title').textContent = 'Créer une catégorie';
            document.getElementById('edit-category-id').value = '';
            document.getElementById('edit-category-name').value = '';
            document.getElementById('edit-category-color').value = '#2c5530';
            document.getElementById('category-modal-alert').innerHTML = '';
            document.getElementById('category-modal').classList.add('active');
        }

        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;
            
            currentEditCategory = category;
            document.getElementById('category-modal-title').textContent = 'Modifier la catégorie';
            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name;
            document.getElementById('edit-category-color').value = category.color || '#2c5530';
            document.getElementById('category-modal-alert').innerHTML = '';
            document.getElementById('category-modal').classList.add('active');
        }

        async function saveCategory(event) {
            event.preventDefault();
            
            const categoryId = document.getElementById('edit-category-id').value;
            const name = document.getElementById('edit-category-name').value;
            const color = document.getElementById('edit-category-color').value;
            
            try {
                const endpoint = categoryId ? '/categories/update' : '/categories/create';
                const payload = categoryId 
                    ? { id: categoryId, name, color }
                    : { name, color };
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    showAlert('category-modal-alert', categoryId ? 'Catégorie mise à jour !' : 'Catégorie créée !', 'success');
                    setTimeout(() => {
                        closeModal('category-modal');
                        loadCategories();
                    }, 1500);
                } else {
                    showAlert('category-modal-alert', 'Erreur lors de la sauvegarde', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('category-modal-alert', 'Erreur serveur', 'error');
            }
        }

        async function deleteCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category || !confirm(`Êtes-vous sûr de vouloir supprimer "${category.name}" ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/categories/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id: id })
                });
                
                if (response.ok) {
                    alert('Catégorie supprimée !');
                    loadCategories();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur serveur');
            }
        }

        // ===== GESTION TAGS =====
        function openCreateTagModal() {
            currentEditTag = null;
            document.getElementById('tag-modal-title').textContent = 'Créer un tag';
            document.getElementById('edit-tag-id').value = '';
            document.getElementById('edit-tag-name').value = '';
            document.getElementById('edit-tag-color').value = '#8B1538';
            document.getElementById('tag-modal-alert').innerHTML = '';
            document.getElementById('tag-modal').classList.add('active');
        }

        function editTag(id) {
            const tag = tags.find(t => t.id === id);
            if (!tag) return;
            
            currentEditTag = tag;
            document.getElementById('tag-modal-title').textContent = 'Modifier le tag';
            document.getElementById('edit-tag-id').value = tag.id;
            document.getElementById('edit-tag-name').value = tag.name;
            document.getElementById('edit-tag-color').value = tag.color || '#8B1538';
            document.getElementById('tag-modal-alert').innerHTML = '';
            document.getElementById('tag-modal').classList.add('active');
        }

        async function saveTag(event) {
            event.preventDefault();
            
            const tagId = document.getElementById('edit-tag-id').value;
            const name = document.getElementById('edit-tag-name').value;
            const color = document.getElementById('edit-tag-color').value;
            
            try {
                const endpoint = tagId ? '/tags/update' : '/tags/create';
                const payload = tagId 
                    ? { id: tagId, name, color }
                    : { name, color };
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    showAlert('tag-modal-alert', tagId ? 'Tag mis à jour !' : 'Tag créé !', 'success');
                    setTimeout(() => {
                        closeModal('tag-modal');
                        loadTags();
                    }, 1500);
                } else {
                    showAlert('tag-modal-alert', 'Erreur lors de la sauvegarde', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('tag-modal-alert', 'Erreur serveur', 'error');
            }
        }

        async function deleteTag(id) {
            const tag = tags.find(t => t.id === id);
            if (!tag || !confirm(`Êtes-vous sûr de vouloir supprimer "${tag.name}" ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/tags/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ id: id })
                });
                
                if (response.ok) {
                    alert('Tag supprimé !');
                    loadTags();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur serveur');
            }
        }
    </script>
</body>
</html>
