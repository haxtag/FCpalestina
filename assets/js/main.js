/**
 * Script principal du portfolio FC Palestina
 */

// ===== INITIALISATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Portfolio FC Palestina initialis√©');
    
    // Initialiser les modules
    initializeApp();
    
    // √âcouter les √©v√©nements de mise √† jour de l'admin
    document.addEventListener('forceReloadGallery', (event) => {
        console.log('üîÑ √âv√©nement de rechargement re√ßu, mise √† jour des donn√©es...');
        loadInitialData();
    });
    
    document.addEventListener('adminDataUpdated', (event) => {
        console.log('üîÑ Donn√©es admin mises √† jour, synchronisation...');
        loadInitialData();
    });
});

/**
 * Initialisation de l'application
 */
async function initializeApp() {
    try {
        // Afficher le loading
        toggleLoading(true);
        
        // Initialiser les composants
        initializeNavigation();
        initializeGallery();
        initializeScrollEffects();
        initializeContactForm();
        
        // Charger les donn√©es initiales
        await loadInitialData();
        
        console.log('‚úÖ Application initialis√©e avec succ√®s');
        
    } catch (error) {
        handleError(error, 'App initialization');
        showNotification('Erreur lors de l\'initialisation de l\'application', 'error');
    } finally {
        toggleLoading(false);
    }
}

/**
 * Initialiser la navigation
 */
function initializeNavigation() {
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    const navLinks = document.querySelectorAll('.nav-link');
    const header = document.querySelector('.header');

    // Toggle du menu mobile
    if (navToggle && navMenu) {
        navToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            navToggle.classList.toggle('active');
        });
    }

    // Fermer le menu mobile au clic sur un lien
    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            navMenu.classList.remove('active');
            navToggle.classList.remove('active');
        });
    });

    // Effet de scroll sur le header
    if (header) {
        window.addEventListener('scroll', throttle(() => {
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        }, 100));
    }

    // Navigation fluide
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            const href = link.getAttribute('href');
            if (href.startsWith('#')) {
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });
}

/**
 * Initialiser la galerie
 */
function initializeGallery() {
    // Attendre que le DOM soit compl√®tement charg√©
    setTimeout(() => {
        try {
            // V√©rifier si l'√©l√©ment de la galerie existe
            const galleryGrid = document.getElementById('gallery-grid');
            if (!galleryGrid) {
                console.error('‚ùå √âl√©ment gallery-grid non trouv√©');
                return;
            }
            
            // Initialiser la galerie
            window.gallery = new Gallery();
            console.log('üì∏ Galerie initialis√©e avec succ√®s');
            
        } catch (error) {
            console.error('‚ùå Erreur initialisation galerie:', error);
        }
    }, 100);
}

/**
 * Initialiser les effets de scroll
 */
function initializeScrollEffects() {
    // Animation des √©l√©ments au scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in-up');
            }
        });
    }, observerOptions);

    // Observer les sections
    const sections = document.querySelectorAll('section');
    sections.forEach(section => {
        observer.observe(section);
    });

    // Observer les √©l√©ments de la galerie
    const galleryItems = document.querySelectorAll('.gallery-item');
    galleryItems.forEach(item => {
        observer.observe(item);
    });
}

/**
 * Initialiser le formulaire de contact
 */
function initializeContactForm() {
    const contactForm = document.querySelector('.contact-form');
    
    if (contactForm) {
        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(contactForm);
            const data = {
                name: formData.get('name') || contactForm.querySelector('input[type="text"]').value,
                email: formData.get('email') || contactForm.querySelector('input[type="email"]').value,
                message: formData.get('message') || contactForm.querySelector('textarea').value
            };

            // Validation
            if (!data.name || !data.email || !data.message) {
                showNotification('Veuillez remplir tous les champs', 'warning');
                return;
            }

            if (!isValidEmail(data.email)) {
                showNotification('Veuillez entrer une adresse email valide', 'warning');
                return;
            }

            try {
                // Simuler l'envoi du formulaire
                await submitContactForm(data);
                showNotification('Message envoy√© avec succ√®s !', 'success');
                contactForm.reset();
            } catch (error) {
                handleError(error, 'Contact form submission');
                showNotification('Erreur lors de l\'envoi du message', 'error');
            }
        });
    }
}

/**
 * Charger les donn√©es initiales
 */
async function loadInitialData() {
    try {
        console.log('üîÑ Chargement des donn√©es initiales...');
        
        // Charger les cat√©gories directement depuis le fichier JSON
        const categoriesResponse = await fetch('/data/categories.json');
        if (categoriesResponse.ok) {
            const categories = await categoriesResponse.json();
            updateCategoryFilters(categories);
            console.log('üìÇ Cat√©gories charg√©es:', categories.length);
        }
        
        // Charger les statistiques
        const stats = await loadStats();
        updateStats(stats);
        
        console.log('‚úÖ Donn√©es initiales charg√©es');
        
    } catch (error) {
        console.warn('Impossible de charger les donn√©es initiales:', error);
    }
}

/**
 * Mettre √† jour les filtres de cat√©gories
 * @param {Array} categories - Liste des cat√©gories
 */
function updateCategoryFilters(categories) {
    const filterContainer = document.querySelector('.gallery-filters');
    if (!filterContainer) return;

    // Supprimer les boutons existants (sauf "Tous")
    const existingButtons = filterContainer.querySelectorAll('.filter-btn:not([data-filter="all"])');
    existingButtons.forEach(btn => btn.remove());

    // Ajouter les nouvelles cat√©gories
    categories.forEach(category => {
        console.log('üé® Cat√©gorie:', category.name, 'Couleur:', category.color);
        const button = document.createElement('button');
        button.className = 'filter-btn';
        button.dataset.filter = category.id;
        button.textContent = category.name;
        
        // Appliquer la couleur de la cat√©gorie
        if (category.color) {
            button.style.backgroundColor = category.color;
            button.style.borderColor = category.color;
            button.style.color = 'white';
            console.log('‚úÖ Couleur appliqu√©e:', category.color);
        } else {
            console.log('‚ùå Pas de couleur pour:', category.name);
        }
        
        // Ajouter l'√©v√©nement de clic
        button.addEventListener('click', (e) => {
            // D√©clencher l'√©v√©nement de la galerie
            const gallery = window.gallery;
            if (gallery) {
                gallery.handleCategoryFilter(category.id);
            }
        });
        
        filterContainer.appendChild(button);
    });
}

/**
 * Charger les statistiques
 * @returns {Object} - Statistiques
 */
async function loadStats() {
    try {
        const jerseys = await jerseyAPI.getJerseys({ limit: 1000 });
        return {
            totalJerseys: jerseys.jerseys.length,
            categories: jerseys.jerseys.reduce((acc, jersey) => {
                acc[jersey.category] = (acc[jersey.category] || 0) + 1;
                return acc;
            }, {}),
            totalViews: jerseys.jerseys.reduce((sum, jersey) => sum + (jersey.views || 0), 0)
        };
    } catch (error) {
        return {
            totalJerseys: 0,
            categories: {},
            totalViews: 0
        };
    }
}

/**
 * Mettre √† jour les statistiques
 * @param {Object} stats - Statistiques
 */
function updateStats(stats) {
    // Mettre √† jour les statistiques dans la section About
    const statElements = document.querySelectorAll('.stat-number');
    if (statElements.length >= 3) {
        statElements[0].textContent = `${stats.totalJerseys}+`;
        statElements[1].textContent = '100%';
        statElements[2].textContent = '24/7';
    }
}

/**
 * Soumettre le formulaire de contact
 * @param {Object} data - Donn√©es du formulaire
 */
async function submitContactForm(data) {
    // Simuler l'envoi du formulaire
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            // Simuler un succ√®s
            console.log('Formulaire envoy√©:', data);
            resolve();
        }, 1000);
    });
}

/**
 * Synchroniser avec Yupoo
 */
async function syncWithYupoo() {
    try {
        showNotification('Synchronisation avec Yupoo en cours...', 'info');
        const success = await jerseyAPI.syncWithYupoo();
        
        if (success) {
            // Recharger la galerie
            const gallery = window.gallery;
            if (gallery) {
                gallery.refresh();
            }
        }
    } catch (error) {
        handleError(error, 'Yupoo sync');
    }
}

/**
 * Gestion des erreurs globales
 */
window.addEventListener('error', (e) => {
    handleError(e.error, 'Global error');
});

window.addEventListener('unhandledrejection', (e) => {
    handleError(e.reason, 'Unhandled promise rejection');
});

/**
 * Gestion de la visibilit√© de la page
 */
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Page cach√©e - √©conomiser les ressources
        console.log('Page cach√©e');
    } else {
        // Page visible - reprendre les activit√©s
        console.log('Page visible');
    }
});

/**
 * Gestion du redimensionnement de la fen√™tre
 */
window.addEventListener('resize', debounce(() => {
    // Recalculer les dimensions si n√©cessaire
    console.log('Fen√™tre redimensionn√©e');
}, 250));

/**
 * Gestion du scroll
 */
window.addEventListener('scroll', throttle(() => {
    // Mettre √† jour la position de scroll si n√©cessaire
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    document.documentElement.style.setProperty('--scroll-top', `${scrollTop}px`);
}, 16));

/**
 * Initialiser les raccourcis clavier
 */
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K pour la recherche
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    // √âchap pour fermer les modals
    if (e.key === 'Escape') {
        const modal = document.getElementById('image-modal');
        if (modal && modal.classList.contains('active')) {
            const closeBtn = modal.querySelector('.modal-close');
            if (closeBtn) {
                closeBtn.click();
            }
        }
    }
});

/**
 * Exposer les fonctions globales
 */
window.syncWithYupoo = syncWithYupoo;
window.jerseyAPI = jerseyAPI;
window.jerseyModal = jerseyModal;

// ===== PERFORMANCE MONITORING =====
if ('performance' in window) {
    window.addEventListener('load', () => {
        setTimeout(() => {
            const perfData = performance.getEntriesByType('navigation')[0];
            console.log('üìä Performance:', {
                loadTime: Math.round(perfData.loadEventEnd - perfData.loadEventStart),
                domContentLoaded: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
                firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime,
                firstContentfulPaint: performance.getEntriesByName('first-contentful-paint')[0]?.startTime
            });
        }, 0);
    });
}

console.log('üéØ Portfolio FC Palestina pr√™t !');
